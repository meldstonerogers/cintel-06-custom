<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Quality Dashboard</title>
    
    <!-- Multiple CDN sources for libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shinylive@0.2.2/shinylive.css">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shinylive@0.2.2/shinylive.js"></script>
</head>
<body>
    <div id="app-container">
        <div id="loading-message" style="color: blue; font-size: 18px;">
            Loading Banana Quality Dashboard... Please wait.
        </div>
        <div id="error-display" style="color: red; font-weight: bold;"></div>
        <div id="shinylive-app"></div>
    </div>

    <script>
        // Comprehensive library loading check
        function checkLibrariesLoaded() {
            const libraries = [
                { name: 'Pyodide', check: () => typeof loadPyodide !== 'undefined' },
                { name: 'Shinylive', check: () => typeof shinylive !== 'undefined' }
            ];

            const missingLibs = libraries
                .filter(lib => !lib.check())
                .map(lib => lib.name);

            if (missingLibs.length > 0) {
                const errorMsg = `Missing libraries: ${missingLibs.join(', ')}`;
                console.error(errorMsg);
                document.getElementById('error-display').textContent = errorMsg;
                document.getElementById('loading-message').style.display = 'none';
                return false;
            }
            return true;
        }

        // Alternative library loading with multiple sources
        function loadLibrariesWithFallback() {
            const libraries = [
                'https://cdn.jsdelivr.net/npm/shinylive@0.2.2/shinylive.js',
                'https://cdnjs.cloudflare.com/ajax/libs/shinylive/0.2.2/shinylive.js'
            ];

            function tryNextSource(index) {
                if (index >= libraries.length) {
                    throw new Error('Could not load Shinylive from any source');
                }

                const script = document.createElement('script');
                script.src = libraries[index];
                script.onload = () => initializeApp();
                script.onerror = () => tryNextSource(index + 1);
                document.head.appendChild(script);
            }

            tryNextSource(0);
        }

        function initializeApp() {
            // Verify libraries are loaded
            if (!checkLibrariesLoaded()) {
                console.error('Libraries not loaded');
                return;
            }

            const BACKEND = 'https://shinylive.io/v2/editor/';
            const CODE = `
# Comprehensive import and error handling
import sys
import os

# Debugging imports
print(f"Python version: {sys.version}")
print(f"Current working directory: {os.getcwd()}")

try:
    import pandas as pd
    import plotly.express as px
    from faicons import icon_svg
    import shiny
    from shiny.express import input, render, ui
    from shinywidgets import render_widget
    from shiny import reactive
except ImportError as e:
    print(f"Import Error: {e}")
    raise

# Read CSV with explicit error handling
try:
    # Use relative path
    bananas_df = pd.read_csv("banana_quality_dataset.csv")
    print(f"CSV loaded successfully. Shape: {bananas_df.shape}")
    print(f"Columns: {list(bananas_df.columns)}")
except Exception as e:
    print(f"Error loading CSV: {e}")
    raise

# Your existing Shiny app code
with ui.sidebar(title="Filter Controls", bg="#8D6B94"):
    options = ["Brazil", "Colombia", "Costa Rica", "Ecuado", "Guatemala", "Honduras", "India", "Philippines"]
    ui.input_checkbox_group(
        "selected_region_list",
        "Select Region",
        choices = options,
        selected=options,
    )

    ui.input_selectize(
        "selected_variety_list",
        "Choose banana variety(ies)",
        ["Burro", "Cavendish", "Fehi", "Manzano", "Plantain"],
        multiple=True,
        selected="Burro",
    )

# Reactive function to filter data
@reactive.calc
def filtered_data():
    isFilterMatch = (
        bananas_df["region"].isin(input.selected_region_list()) &
        bananas_df["variety"].isin(input.selected_variety_list())
    )
    return bananas_df[isFilterMatch]

# Rest of your app code...
print("Shiny app definition complete.")
`;
            
            try {
                const runtime = new shinylive.ShinyLiveRuntime(
                    document.getElementById('shinylive-app'), 
                    BACKEND, 
                    {'main.py': CODE}
                );
                runtime.run();
                
                // Hide loading message when app starts
                document.getElementById('loading-message').style.display = 'none';
            } catch (error) {
                console.error("Shinylive Runtime Error:", error);
                document.getElementById('error-display').textContent = 
                    `Error initializing app: ${error.message}`;
                document.getElementById('loading-message').style.display = 'none';
            }
        }

        // Attempt to load libraries when page loads
        window.addEventListener('load', () => {
            try {
                if (checkLibrariesLoaded()) {
                    initializeApp();
                } else {
                    loadLibrariesWithFallback();
                }
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('error-display').textContent = 
                    `Initialization error: ${error.message}`;
            }
        });
    </script>
</body>
</html>